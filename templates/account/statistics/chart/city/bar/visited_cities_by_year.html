<div class="flex flex-col gap-4 rounded-xl border border-gray-200 bg-white p-6 shadow-sm dark:border-neutral-700 dark:bg-neutral-900">
    <h2 class="text-xl font-semibold text-gray-900 dark:text-white text-center">Общее количество посещённых городов по годам</h2>
    
    {% if cities.number_of_visited_cities_in_several_years %}
        <div class="flex items-center justify-center">
            <canvas id="chart__total_cities_by_year"></canvas>
        </div>
    {% else %}
        <div class="rounded-lg border border-red-200 bg-red-50 p-4 text-center dark:border-red-500/40 dark:bg-red-500/10">
            <p class="text-sm text-red-700 dark:text-red-300">
                Не сохранено ни одного города с указанием даты посещения
            </p>
        </div>
    {% endif %}
</div>

<script>
    const ctx_total_cities_by_year = document.getElementById('chart__total_cities_by_year')?.getContext('2d');
    if (ctx_total_cities_by_year) {
        let data_year_total_cities_by_year = {}
        {% for year in cities.number_of_visited_cities_in_several_years %}
            data_year_total_cities_by_year['{{ year.year|date:'Y' }}'] = '{{ year.qty }}'
        {% endfor %}

        const isDarkMode = document.documentElement.classList.contains('dark');
        const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
        const textColor = isDarkMode ? 'rgba(255, 255, 255, 0.7)' : 'rgba(0, 0, 0, 0.7)';

        new Chart(ctx_total_cities_by_year, {
            type: 'bar',
            data: {
                labels: Object.keys(data_year_total_cities_by_year),
                datasets: [
                    {
                        label: 'Всего посещено городов в этом году',
                        data: Object.values(data_year_total_cities_by_year),
                        borderColor: isDarkMode ? 'rgba(14, 165, 233, 0.8)' : 'rgba(14, 165, 233, 0.6)',
                        backgroundColor: isDarkMode ? 'rgba(14, 165, 233, 0.2)' : 'rgba(14, 165, 233, 0.15)',
                        borderWidth: 2,
                        borderRadius: 6,
                        borderSkipped: false
                    },
                ],
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            color: textColor,
                            font: {
                                size: 12
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: isDarkMode ? 'rgba(23, 23, 23, 0.98)' : 'rgba(255, 255, 255, 0.98)',
                        titleColor: isDarkMode ? 'rgba(255, 255, 255, 1)' : 'rgba(0, 0, 0, 1)',
                        bodyColor: isDarkMode ? 'rgba(255, 255, 255, 0.9)' : 'rgba(0, 0, 0, 0.9)',
                        borderColor: isDarkMode ? 'rgba(255, 255, 255, 0.2)' : 'rgba(0, 0, 0, 0.2)',
                        borderWidth: 1,
                        padding: 12,
                        cornerRadius: 8,
                        boxPadding: 6,
                        titleFont: {
                            weight: 'bold',
                            size: 13
                        },
                        bodyFont: {
                            size: 12
                        },
                        displayColors: true,
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + context.parsed.y;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: {
                            color: gridColor,
                            drawBorder: false
                        },
                        ticks: {
                            color: textColor,
                            font: {
                                size: 11
                            }
                        }
                    },
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: gridColor,
                            drawBorder: false
                        },
                        ticks: {
                            color: textColor,
                            font: {
                                size: 11
                            }
                        }
                    }
                }
            }
        });
    }
</script>
