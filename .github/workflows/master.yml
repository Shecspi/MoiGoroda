name: Deploy to the server
on:
    push:
        branches:
            - master
            - fix-ci-tests
            - feature/global-redesign
    release:
        types: [published]

jobs:
    changelog:
        name: Generate changelog
        if: github.ref == 'refs/heads/master'
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Generate a changelog
              uses: orhun/git-cliff-action@v4
              with:
                  config: cliff.toml
                  args: --verbose
              env:
                  OUTPUT: CHANGELOG.md
                  GITHUB_REPO: ${{ github.repository }}

            - name: Commit the genereted changelog
              run: |
                  git config user.name 'github-actions[bot]'
                  git config user.email 'github-actions[bot]@users.noreply.github.com'
                  set +e
                  git switch master
                  git add CHANGELOG.md
                  git commit -m "Обновление CHANGELOG.md"
                  git push https://${{ secrets.GITHUB_TOKEN }}@github.com/${GITHUB_REPOSITORY}.git master

    test:
        name: Run tests
        if: github.ref == 'refs/heads/master'
        runs-on: ubuntu-latest

        services:
            postgres:
                image: postgres:15
                env:
                    POSTGRES_USER: test_user
                    POSTGRES_PASSWORD: test_password
                    POSTGRES_DB: test_db
                ports:
                    - 5432:5432
                options: >-
                    --health-cmd pg_isready
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"

            - name: Install and build frontend
              run: |
                  make frontend-install
                  make frontend-build

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.12"

            - name: Create .env file
              run: |
                  cp MoiGoroda/.env.example MoiGoroda/.env
                  # Настраиваем PostgreSQL для тестов
                  sed -i 's/DATABASE_ENGINE=django.db.backends.sqlite3/DATABASE_ENGINE=django.db.backends.postgresql/' MoiGoroda/.env
                  sed -i 's/DATABASE_NAME=db_name/DATABASE_NAME=test_db/' MoiGoroda/.env
                  sed -i 's/DATABASE_USER=user_name/DATABASE_USER=test_user/' MoiGoroda/.env
                  sed -i 's/DATABASE_PASSWORD=password/DATABASE_PASSWORD=test_password/' MoiGoroda/.env
                  sed -i 's/DATABASE_HOST=127.0.0.1/DATABASE_HOST=localhost/' MoiGoroda/.env
                  # Устанавливаем переменную для тестового режима
                  echo "DEBUG=False" >> MoiGoroda/.env
                  echo "TESTING=True" >> MoiGoroda/.env

            - name: Install Poetry
              uses: snok/install-poetry@v1
              with:
                  version: 1.8.2
                  virtualenvs-create: true
                  virtualenvs-in-project: true

            - name: Install dependencies
              run: poetry install --no-interaction --with test

            - name: Run migrations
              run: poetry run python manage.py migrate

            - name: Run tests
              run: make test

    mypy:
        name: Type checking with mypy
        if: github.ref == 'refs/heads/master'
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"

            - name: Install and build frontend
              run: |
                  make frontend-install
                  make frontend-build

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.12"

            - name: Install Poetry
              uses: snok/install-poetry@v1
              with:
                  version: 1.8.2
                  virtualenvs-create: true
                  virtualenvs-in-project: true

            - name: Install dependencies
              run: poetry install --no-interaction --with dev

            - name: Run mypy
              run: make lint-mypy

    ruff:
        name: Linting with ruff
        if: github.ref == 'refs/heads/master'
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"

            - name: Install and build frontend
              run: |
                  make frontend-install
                  make frontend-build

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.12"

            - name: Install Poetry
              uses: snok/install-poetry@v1
              with:
                  version: 1.8.2
                  virtualenvs-create: true
                  virtualenvs-in-project: true

            - name: Install dependencies
              run: poetry install --no-interaction --with dev

            - name: Run ruff
              run: make lint-ruff

    deploy:
        name: Deploy to server
        if: github.ref == 'refs/heads/master'
        needs: [test, mypy, ruff]
        runs-on: [self-hosted, prod]
        steps:
            - uses: actions/checkout@v4
            - name: Get all git tags
              run: git fetch --tags --force

            - name: Deploy to the server
              run: |
                  : # Переходим в папку с проектом
                  cd ${{ secrets.PROD__PROJECT_PATH }}

                  git pull origin master
                  git checkout master

                  : # Устанавливаем необходимую версию Python, если она ещё не установлена
                  if [[ "$(pyenv versions 2> /dev/null)" != *"$(cat .python-version )"* ]]; then pyenv install $(cat .python-version); fi

                  : # Удаляем виртуальное окружение и создаём новое на основе той версии Python,
                  : # которая указана в .python-version
                  if [ -n $(poetry env info -p) ]; then rm -rf $(poetry env info -p); fi
                  poetry env use $(cat .python-version)
                  poetry lock
                  poetry install --only main

                  : # Для того чтобы в конфиге Gunicorn прописать путь к исполняемому файлу,
                  : # нужно создать символичесвую ссылку на файл, находящийся в папке с виртуальным окружением.
                  : # Имя папки может меняться, поэтому нужен такой ход.
                  rm -f ~/gunicorn
                  ln -s $(poetry env info -p)/bin/gunicorn ~/gunicorn

                  poetry run python3 manage.py migrate

                  # Собираем JS файлы
                  cd frontend
                  npm ci
                  npm run build
                  cd ../

                  : # Производим сборку статичных файлов
                  poetry run python3 manage.py collectstatic --noinput

                  : # Перезагружаем сервер
                  echo "${{ secrets.PROD__SUDO_PASSWORD }}" | sudo -S systemctl daemon-reload
                  echo "${{ secrets.PROD__SUDO_PASSWORD }}" | sudo -S systemctl restart gunicorn

    deploy-dev:
        name: Deploy to dev server
        if: github.ref == 'refs/heads/feature/global-redesign'
        runs-on: [self-hosted, dev]
        steps:
            - uses: actions/checkout@v4

            - name: Set output
              id: vars
              run: echo "short_ref=${GITHUB_REF#refs/*/}" >> $GITHUB_OUTPUT

            - name: Deploy to dev server
              run: |
                  : # Переходим в папку с проектом
                  cd ${{ secrets.DEV__PROJECT_PATH }}

                  git pull origin ${{ steps.vars.outputs.short_ref }}
                  git checkout ${{ steps.vars.outputs.short_ref }}

                  : # Устанавливаем необходимую версию Python, если она ещё не установлена
                  if [[ "$(pyenv versions 2> /dev/null)" != *"$(cat .python-version )"* ]]; then pyenv install $(cat .python-version); fi

                  : # Удаляем виртуальное окружение и создаём новое на основе той версии Python,
                  : # которая указана в .python-version
                  if [ -n $(poetry env info -p) ]; then rm -rf $(poetry env info -p); fi
                  poetry env use $(cat .python-version)
                  poetry lock
                  poetry install --only main

                  : # Для того чтобы в конфиге Gunicorn прописать путь к исполняемому файлу,
                  : # нужно создать символичесвую ссылку на файл, находящийся в папке с виртуальным окружением.
                  rm -f ~/gunicorn
                  ln -s $(poetry env info -p)/bin/gunicorn ~/gunicorn

                  poetry run python3 manage.py makemigrations
                  poetry run python3 manage.py migrate

                  : # Собираем JS файлы
                  cd frontend
                  npm ci
                  npm run build
                  cd ../

                  : # Производим сборку статичных файлов
                  poetry run python3 manage.py collectstatic --noinput

                  : # Перезагружаем сервер
                  echo "${{ secrets.DEV__SUDO_PASSWORD }}" | sudo -S systemctl daemon-reload
                  echo "${{ secrets.DEV__SUDO_PASSWORD }}" | sudo -S systemctl restart gunicorn
