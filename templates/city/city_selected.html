{% extends 'base.html' %}
{% load vite %}
{% load humanize %}
{% load markdownify %}
{% load static %}
{% load mathfilters %}

{% block extra_css %}
    {{ block.super }}
    {% vite_css 'css/tailwind' %}
{% endblock %}

{% block content %}
{% if not DEBUG %}
    {% if not user.is_authenticated %}
        {% include 'advertisement/rtb_floor_fullscreen_mobile.html' %}
    {% endif %}
{% endif %}

<!-- Заголовок страницы -->
<header class="mx-3 mt-10 mb-8 text-center" id="block-page_header">
    <h1 class="text-3xl font-bold tracking-tight text-gray-900 sm:text-4xl lg:text-5xl dark:text-white">
        {{ city.title }}
    </h1>
</header>
<!-- ^^^ Заголовок страницы -->

{% if not user.is_authenticated %}
    {% include 'advertisement/rtb_floor_fullscreen_mobile.html' %}
{% endif %}

<div class="mx-3 mb-8 flex justify-center">
    <div class="w-full max-w-6xl">
        <!-- Основная карточка с информацией о городе -->
        <div class="rounded-xl border border-gray-200 bg-white p-6 shadow-sm dark:border-neutral-700 dark:bg-neutral-900 mb-6" id="city-selected-content">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Изображение города -->
                <div class="text-center" id="section-city_image">
                    {% if city.image %}
                        <img src="{{ city.image }}"
                             alt="Фото города {{ city.title }}"
                             class="inline-block max-w-full h-auto max-h-[600px] rounded-lg shadow-lg"
                             onerror="this.onerror=null;this.src='{% static 'image/city_placeholder.png' %}'">
                    {% else %}      
                        <img src="{% static 'image/city_placeholder.png' %}"
                             alt="Фото города {{ city.title }}"
                             class="inline-block max-w-full h-auto max-h-[600px] rounded-lg shadow-lg">
                    {% endif %}
                    {% if city.image_source_text %}
                        <div class="mt-3 text-sm text-gray-600 dark:text-neutral-400">
                            Источник изображения:<br>
                            {% if city.image_source_link %}
                                <a href="{{ city.image_source_link }}"
                                   class="text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 hover:underline"
                                   target="_blank">{{ city.image_source_text }}</a>
                            {% else %}
                                {{ city.image_source_text }}
                            {% endif %}
                        </div>
                    {% endif %}
                </div>

                <!-- Информация о городе -->
                <div class="space-y-4">
                    <!-- Кнопки действий -->
                    <div class="flex flex-wrap gap-2 justify-end">
                        <button id="show_on_map"
                                class="inline-flex items-center gap-x-2 px-4 py-2 text-sm font-semibold rounded-xl border border-emerald-500 text-emerald-600 shadow-sm transition hover:bg-emerald-50 hover:shadow-md focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2 dark:border-emerald-400 dark:text-emerald-300 dark:hover:bg-emerald-500/10 dark:focus:ring-offset-neutral-800"
                                role="button"
                                data-hs-overlay="#cityStatisticModal">
                            <svg xmlns="http://www.w3.org/2000/svg" class="size-4" viewBox="0 0 640 640" fill="currentColor">
                                <path d="M96 96C113.7 96 128 110.3 128 128L128 464C128 472.8 135.2 480 144 480L544 480C561.7 480 576 494.3 576 512C576 529.7 561.7 544 544 544L144 544C99.8 544 64 508.2 64 464L64 128C64 110.3 78.3 96 96 96zM304 160C310.7 160 317.1 162.8 321.7 167.8L392.8 245.3L439 199C448.4 189.6 463.6 189.6 472.9 199L536.9 263C541.4 267.5 543.9 273.6 543.9 280L543.9 392C543.9 405.3 533.2 416 519.9 416L215.9 416C202.6 416 191.9 405.3 191.9 392L191.9 280C191.9 274 194.2 268.2 198.2 263.8L286.2 167.8C290.7 162.8 297.2 160 303.9 160z"/>
                            </svg>
                            Статистика города
                        </button>

                        <button id="show_on_map"
                                class="inline-flex items-center gap-x-2 px-4 py-2 text-sm font-semibold rounded-xl border border-gray-200 text-gray-800 shadow-sm transition hover:bg-gray-50 hover:shadow-md focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 dark:border-neutral-700 dark:text-white dark:hover:bg-neutral-700 dark:focus:ring-offset-neutral-800"
                                role="button"
                                data-hs-overlay="#mapModal">
                            <svg xmlns="http://www.w3.org/2000/svg" class="size-4" viewBox="0 0 384 512" fill="currentColor">
                                <path d="M215.7 499.2C267 435 384 279.4 384 192C384 86 298 0 192 0S0 86 0 192c0 87.4 117 243 168.3 307.2c12.3 15.3 35.1 15.3 47.4 0zM192 128a64 64 0 1 1 0 128 64 64 0 1 1 0-128z"/>
                            </svg>
                            Посмотреть на карте
                        </button>
                    </div>

                    <hr class="border-gray-200 dark:border-neutral-700">

                    <!-- Основная информация -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        {% url 'region-selected-list' city.region.id as region_url %}
                        <div class="rounded-lg border-l-4 border-blue-500 bg-blue-50 p-4 dark:bg-blue-500/10 dark:border-blue-400" id="section-country">
                            <div class="flex items-center gap-2 mb-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="size-4 text-blue-600 dark:text-blue-400" viewBox="0 0 640 640" fill="currentColor">
                                    <path d="M320.2 112C435 112.1 528 205.2 528 320C528 342.1 524.6 363.4 518.2 383.4C516.2 383.8 514.1 384 512 384L509.3 384C500.8 384 492.7 380.6 486.7 374.6L457.4 345.3C451.4 339.3 448 331.2 448 322.7L448 272C448 263.2 455.2 256 464 256C472.8 256 480 248.8 480 240C480 231.2 472.8 224 464 224L440 224C426.7 224 416 234.7 416 248C416 261.3 405.3 272 392 272L336 272C327.2 272 320 279.2 320 288C320 296.8 312.8 304 304 304L278.6 304C266.1 304 256 293.9 256 281.4C256 275.4 258.4 269.6 262.6 265.4L332.7 195.3C334.8 193.2 336 190.3 336 187.3C336 181.1 330.9 176 324.7 176L310.6 176C298.1 176 288 165.9 288 153.4C288 147.4 290.4 141.6 294.6 137.4L317.7 114.3C318.5 113.5 319.3 112.8 320.2 112.1zM502.4 420.1C469.6 479.7 408.5 521.5 337.2 527.3C336.5 525 336.1 522.5 336.1 520C336.1 506.7 325.4 496 312.1 496L285.4 496C276.9 496 268.8 492.6 262.8 486.6L233.5 457.3C227.5 451.3 224.1 443.2 224.1 434.7L224.1 368C224.1 350.3 238.4 336 256.1 336L354.8 336C363.3 336 371.4 339.4 377.4 345.4L406.7 374.7C412.7 380.7 420.8 384.1 429.3 384.1L434.8 384.1C443.3 384.1 451.4 387.5 457.4 393.5L473.4 409.5C477.6 413.7 483.4 416.1 489.4 416.1C494.2 416.1 498.7 417.6 502.4 420.2zM320 576L346.2 574.7C337.6 575.6 328.9 576 320 576zM346.2 574.7C475.3 561.6 576 452.6 576 320C576 178.6 461.4 64 320 64L320 64C178.6 64 64 178.6 64 320C64 447.5 157.2 553.3 279.3 572.8C292.5 574.9 306.1 576 320 576zM251.3 187.3L219.3 219.3C213.1 225.5 202.9 225.5 196.7 219.3C190.5 213.1 190.5 202.9 196.7 196.7L228.7 164.7C234.9 158.5 245.1 158.5 251.3 164.7C257.5 170.9 257.5 181.1 251.3 187.3z"/>
                                </svg>
                                <div class="text-xs font-semibold text-blue-600 dark:text-blue-400">Страна</div>
                            </div>
                            <div class="text-base font-bold text-gray-900 dark:text-white">{{ city.country }}</div>
                        </div>
                        <div class="rounded-lg border-l-4 border-emerald-500 bg-emerald-50 p-4 dark:bg-emerald-500/10 dark:border-emerald-400" id="section-region">
                            <div class="flex items-center gap-2 mb-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="size-4 text-emerald-600 dark:text-emerald-400" viewBox="0 0 640 640" fill="currentColor">
                                    <path d="M576 112C576 100.9 570.3 90.6 560.8 84.8C551.3 79 539.6 78.4 529.7 83.4L413.5 141.5L234.1 81.6C226 78.9 217.3 79.5 209.7 83.3L81.7 147.3C70.8 152.8 64 163.9 64 176L64 528C64 539.1 69.7 549.4 79.2 555.2C88.7 561 100.4 561.6 110.3 556.6L226.4 498.5L399.7 556.3C395.4 549.9 391.2 543.2 387.1 536.4C376.1 518.1 365.2 497.1 357.1 474.6L255.9 440.9L255.9 156.4L383.9 199.1L383.9 298.4C414.9 262.6 460.9 240 511.9 240C534.5 240 556.1 244.4 575.9 252.5L576 112zM512 288C445.7 288 392 340.8 392 405.9C392 474.8 456.1 556.3 490.6 595.2C502.2 608.2 521.9 608.2 533.5 595.2C568 556.3 632.1 474.8 632.1 405.9C632.1 340.8 578.4 288 512.1 288zM472 408C472 385.9 489.9 368 512 368C534.1 368 552 385.9 552 408C552 430.1 534.1 448 512 448C489.9 448 472 430.1 472 408z"/>
                                </svg>
                                <div class="text-xs font-semibold text-emerald-600 dark:text-emerald-400">Регион</div>
                            </div>
                            <div class="text-base font-bold text-gray-900 dark:text-white">
                                <a href="{{ region_url }}" class="text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 hover:underline">{{ city.region }}</a>
                            </div>
                        </div>
                        {% if city.region.area %}
                        <div class="rounded-lg border-l-4 border-purple-500 bg-purple-50 p-4 dark:bg-purple-500/10 dark:border-purple-400" id="section-area">
                            <div class="flex items-center gap-2 mb-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="size-4 text-purple-600 dark:text-purple-400" viewBox="0 0 640 640" fill="currentColor">
                                    <path d="M415.9 344L225 344C227.9 408.5 242.2 467.9 262.5 511.4C273.9 535.9 286.2 553.2 297.6 563.8C308.8 574.3 316.5 576 320.5 576C324.5 576 332.2 574.3 343.4 563.8C354.8 553.2 367.1 535.8 378.5 511.4C398.8 467.9 413.1 408.5 416 344zM224.9 296L415.8 296C413 231.5 398.7 172.1 378.4 128.6C367 104.2 354.7 86.8 343.3 76.2C332.1 65.7 324.4 64 320.4 64C316.4 64 308.7 65.7 297.5 76.2C286.1 86.8 273.8 104.2 262.4 128.6C242.1 172.1 227.8 231.5 224.9 296zM176.9 296C180.4 210.4 202.5 130.9 234.8 78.7C142.7 111.3 74.9 195.2 65.5 296L176.9 296zM65.5 344C74.9 444.8 142.7 528.7 234.8 561.3C202.5 509.1 180.4 429.6 176.9 344L65.5 344zM463.9 344C460.4 429.6 438.3 509.1 406 561.3C498.1 528.6 565.9 444.8 575.3 344L463.9 344zM575.3 296C565.9 195.2 498.1 111.3 406 78.7C438.3 130.9 460.4 210.4 463.9 296L575.3 296z"/>
                                </svg>
                                <div class="text-xs font-semibold text-purple-600 dark:text-purple-400">Федеральный округ</div>
                            </div>
                            <div class="text-base font-bold text-gray-900 dark:text-white">{{ city.region.area }}</div>
                        </div>
                        {% endif %}
                        <div class="rounded-lg border-l-4 border-amber-500 bg-amber-50 p-4 dark:bg-amber-500/10 dark:border-amber-400" id="section-date_of_foundation">
                            <div class="flex items-center gap-2 mb-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="size-4 text-amber-600 dark:text-amber-400" viewBox="0 0 448 512" fill="currentColor">
                                    <path d="M152 24c0-13.3-10.7-24-24-24s-24 10.7-24 24V64H64C28.7 64 0 92.7 0 128v16 48V448c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V192 144 128c0-35.3-28.7-64-64-64H344V24c0-13.3-10.7-24-24-24s-24 10.7-24 24V64H152V24zM48 192H400V448c0 8.8-7.2 16-16 16H64c-8.8 0-16-7.2-16-16V192z"/>
                                </svg>
                                <div class="text-xs font-semibold text-amber-600 dark:text-amber-400">Год основания</div>
                            </div>
                            <div class="text-base font-bold text-gray-900 dark:text-white">
                                {% if city.date_of_foundation %}{{ city.date_of_foundation }}{% else %}<span class="text-gray-500 dark:text-neutral-500">Не указано</span>{% endif %}
                            </div>
                        </div>
                        <div class="rounded-lg border-l-4 border-red-500 bg-red-50 p-4 dark:bg-red-500/10 dark:border-red-400" id="section-population">
                            <div class="flex items-center gap-2 mb-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="size-4 text-red-600 dark:text-red-400" viewBox="0 0 448 512" fill="currentColor">
                                    <path d="M224 256a128 128 0 1 0 0-256 128 128 0 1 0 0 256zm-45.7 48C79.8 304 0 383.8 0 482.3C0 498.7 13.3 512 29.7 512H418.3c16.4 0 29.7-13.3 29.7-29.7C448 383.8 368.2 304 269.7 304H178.3z"/>
                                </svg>
                                <div class="text-xs font-semibold text-red-600 dark:text-red-400">Население</div>
                            </div>
                            <div class="text-base font-bold text-gray-900 dark:text-white">
                                {% if city.population %}{{ city.population|intcomma }}{% else %}<span class="text-gray-500 dark:text-neutral-500">Не указано</span>{% endif %}
                            </div>
                        </div>
                    </div>

                    <hr class="border-gray-200 dark:border-neutral-700">

                    <!-- Коллекции -->
                    <div>
                        <h6 class="text-sm font-semibold text-gray-800 dark:text-neutral-300 mb-2">Коллекции:</h6>
                        <div class="flex flex-wrap gap-2">
                            {% if collections %}
                                {% for collection in collections %}
                                    <a href="{% url 'collection-detail-list' collection.id %}"
                                       class="inline-flex items-center gap-x-1.5 px-3 py-1.5 text-xs font-medium rounded-lg border border-emerald-200 bg-emerald-50 text-emerald-700 hover:bg-emerald-100 dark:border-emerald-500/40 dark:bg-emerald-500/10 dark:text-emerald-400">
                                        {{ collection }}
                                    </a>
                                {% endfor %}
                            {% else %}
                                <span class="text-sm text-gray-500 dark:text-neutral-500">Город не состоит ни в каких коллекциях</span>
                            {% endif %}
                        </div>
                    </div>

                    <hr class="border-gray-200 dark:border-neutral-700">

                    <!-- Статистика -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <h6 class="text-sm font-semibold text-gray-800 dark:text-neutral-300 mb-2">Средняя оценка среди всех пользователей:</h6>
                            <div class="flex items-center gap-3">
                                {% if average_rating %}
                                    <span class="text-lg font-semibold text-gray-900 dark:text-white">
                                        {{ average_rating }}
                                    </span>
                                    <div class="flex items-center gap-0.5">
                                        {% for i in "12345"|make_list %}
                                            {% with index=forloop.counter %}
                                                {% if average_rating >= index %}
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="size-5 text-yellow-400" viewBox="0 0 576 512" fill="currentColor">
                                                        <path d="M287.9 0c9.2 0 17.6 5.2 21.6 13.5l68.6 141.3 153.2 22.6c9 1.3 16.5 7.6 19.3 16.3s.5 18.1-5.9 24.5L433.6 328.4l26.2 155.6c1.5 9-2.2 18.1-9.6 23.5s-17.3 6-25.3 1.7l-137-73.2L151 509.1c-8.1 4.3-17.9 3.7-25.3-1.7s-11.2-14.5-9.7-23.5l26.2-155.6L31.1 218.2c-6.5-6.4-8.7-15.9-5.9-24.5s10.3-14.9 19.3-16.3l153.2-22.6L266.3 13.5C270.4 5.2 278.7 0 287.9 0z"/>
                                                    </svg>
                                                {% else %}
                                                    {% if average_rating >= index|sub:0.5 %}
                                                        <svg xmlns="http://www.w3.org/2000/svg" class="size-5 text-yellow-400" viewBox="0 0 640 512" fill="currentColor">
                                                            <path d="M320 0c-9.2 0-17.6 5.2-21.6 13.5l-68.6 141.3L136.6 177c-9 1.3-16.5 7.6-19.3 16.3s-.5 18.1 5.9 24.5L218.4 328.4l-26.2 155.6c-1.5 9 2.2 18.1 9.6 23.5s17.3 6 25.3 1.7L320 402.1l137 73.2c8.1 4.3 17.9 3.7 25.3-1.7s11.2-14.5 9.7-23.5L456.6 328.4l95.2-110.6c6.5-6.4 8.7-15.9 5.9-24.5s-10.3-14.9-19.3-16.3L375.2 155l-68.6-141.3C302.4 5.2 294.1 0 284.9 0H320zm0 64v0z"/>
                                                        </svg>
                                                    {% else %}
                                                        <svg xmlns="http://www.w3.org/2000/svg" class="size-5 text-gray-300 dark:text-neutral-600" viewBox="0 0 576 512" fill="currentColor">
                                                            <path d="M287.9 0c9.2 0 17.6 5.2 21.6 13.5l68.6 141.3 153.2 22.6c9 1.3 16.5 7.6 19.3 16.3s.5 18.1-5.9 24.5L433.6 328.4l26.2 155.6c1.5 9-2.2 18.1-9.6 23.5s-17.3 6-25.3 1.7l-137-73.2L151 509.1c-8.1 4.3-17.9 3.7-25.3-1.7s-11.2-14.5-9.7-23.5l26.2-155.6L31.1 218.2c-6.5-6.4-8.7-15.9-5.9-24.5s10.3-14.9 19.3-16.3l153.2-22.6L266.3 13.5C270.4 5.2 278.7 0 287.9 0z"/>
                                                        </svg>
                                                    {% endif %}
                                                {% endif %}
                                            {% endwith %}
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <span class="text-sm text-gray-500 dark:text-neutral-500">Статистика ещё не собрана</span>
                                {% endif %}
                            </div>
                        </div>

                        <div>
                            <h6 class="text-sm font-semibold text-gray-800 dark:text-neutral-300 mb-2">Популярные месяцы для посещения:</h6>
                            <div class="text-sm text-gray-600 dark:text-neutral-400">
                                {% if popular_months %}
                                    {{ popular_months|join:", " }}
                                {% else %}
                                    <span class="text-gray-500 dark:text-neutral-500">Статистика ещё не собрана</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <hr class="border-gray-200 dark:border-neutral-700">

                    <!-- Ссылка на Wikipedia -->
                    {% if city.wiki %}
                        <div class="flex justify-end">
                            <a href="{{ city.wiki }}"
                               class="inline-flex items-center gap-x-2 text-sm text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 hover:underline"
                               target="_blank">
                                <svg xmlns="http://www.w3.org/2000/svg" class="size-4" viewBox="0 0 448 512" fill="currentColor">
                                    <path d="M448 80v352c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V80c0-26.5 21.5-48 48-48h352c26.5 0 48 21.5 48 48zM92.5 220.5l123.8 130.7V340h100.2v-22.6l123.8-130.7c4.9-5.2 4.4-13.1-.8-17.6l-19.3-20.4c-5.2-5.5-13.1-6-18.1-.7L321.3 239l-64.7-65.1-64.7 65.1L93.1 183.1c-5-5.3-13-4.8-18.1.7l-19.3 20.4c-5.2 4.5-5.7 12.4-.8 17.6z"/>
                                </svg>
                                Больше информации о городе на Wikipedia
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Посещения пользователя -->
            {% if user.is_authenticated %}
                {% if number_of_visits > 0 %}
                    <div class="mt-8 pt-6 border-t border-gray-200 dark:border-neutral-700">
                        <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-6">
                            Ваши посещения города {{ city.title }} ({{ number_of_visits }})
                        </h2>

                        <div class="space-y-6">
                            {% for visit in visits %}
                                <div class="rounded-lg border border-gray-200 bg-gray-50 p-4 dark:border-neutral-700 dark:bg-neutral-800/50">
                                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 items-start">
                                        <!-- Дата посещения -->
                                        <div class="lg:col-span-2">
                                            <div class="text-sm font-semibold text-gray-800 dark:text-neutral-300 mb-1">Дата:</div>
                                            <div class="text-sm text-gray-600 dark:text-neutral-400">
                                                {% if visit.date_of_visit %}
                                                    {{ visit.date_of_visit }}
                                                {% else %}
                                                    <span class="text-gray-500 dark:text-neutral-500">Не указана</span>
                                                {% endif %}
                                            </div>
                                        </div>

                                        <!-- Оценка -->
                                        <div class="lg:col-span-2">
                                            <div class="text-sm font-semibold text-gray-800 dark:text-neutral-300 mb-1">Оценка:</div>
                                            <div class="flex items-center gap-0.5">
                                                {% for i in '12345'|make_list %}
                                                    {% if forloop.counter <= visit.rating %}
                                                        <svg xmlns="http://www.w3.org/2000/svg" class="size-4 text-yellow-400" viewBox="0 0 576 512" fill="currentColor">
                                                            <path d="M287.9 0c9.2 0 17.6 5.2 21.6 13.5l68.6 141.3 153.2 22.6c9 1.3 16.5 7.6 19.3 16.3s.5 18.1-5.9 24.5L433.6 328.4l26.2 155.6c1.5 9-2.2 18.1-9.6 23.5s-17.3 6-25.3 1.7l-137-73.2L151 509.1c-8.1 4.3-17.9 3.7-25.3-1.7s-11.2-14.5-9.7-23.5l26.2-155.6L31.1 218.2c-6.5-6.4-8.7-15.9-5.9-24.5s10.3-14.9 19.3-16.3l153.2-22.6L266.3 13.5C270.4 5.2 278.7 0 287.9 0z"/>
                                                        </svg>
                                                    {% else %}
                                                        <svg xmlns="http://www.w3.org/2000/svg" class="size-4 text-gray-300 dark:text-neutral-600" viewBox="0 0 576 512" fill="currentColor">
                                                            <path d="M287.9 0c9.2 0 17.6 5.2 21.6 13.5l68.6 141.3 153.2 22.6c9 1.3 16.5 7.6 19.3 16.3s.5 18.1-5.9 24.5L433.6 328.4l26.2 155.6c1.5 9-2.2 18.1-9.6 23.5s-17.3 6-25.3 1.7l-137-73.2L151 509.1c-8.1 4.3-17.9 3.7-25.3-1.7s-11.2-14.5-9.7-23.5l26.2-155.6L31.1 218.2c-6.5-6.4-8.7-15.9-5.9-24.5s10.3-14.9 19.3-16.3l153.2-22.6L266.3 13.5C270.4 5.2 278.7 0 287.9 0z"/>
                                                        </svg>
                                                    {% endif %}
                                                {% endfor %}
                                            </div>
                                        </div>

                                        <!-- Описание -->
                                        <div class="lg:col-span-6">
                                            <div class="text-sm font-semibold text-gray-800 dark:text-neutral-300 mb-1">Описание:</div>
                                            <div class="text-sm text-gray-600 dark:text-neutral-400 prose prose-sm dark:prose-invert max-w-none">
                                                {% if visit.impression %}
                                                    {{ visit.impression|markdownify }}
                                                {% else %}
                                                    <span class="text-gray-500 dark:text-neutral-500">Вы не добавили описание Вашей поездки в город {{ visit.city__title }}</span>
                                                {% endif %}
                                            </div>
                                        </div>

                                        <!-- Действия -->
                                        <div class="lg:col-span-2 flex justify-end gap-2">
                                            <a class="inline-flex items-center gap-x-1.5 px-3 py-2 text-sm font-semibold rounded-lg border border-red-200 bg-red-50 text-red-700 hover:bg-red-100 dark:border-red-500/40 dark:bg-red-500/10 dark:text-red-400 delete_city"
                                               href="#"
                                               data-delete_url="{% url 'city-delete' visit.id %}"
                                               data-hs-overlay="#deleteModal">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="size-4" viewBox="0 0 448 512" fill="currentColor">
                                                    <path d="M135.2 17.7L128 32H32C14.3 32 0 46.3 0 64S14.3 96 32 96H416c17.7 0 32-14.3 32-32s-14.3-32-32-32H320l-7.2-14.3C307.4 6.8 296.3 0 284.2 0H163.8c-12.1 0-23.2 6.8-28.6 17.7zM416 128H32L53.2 467c1.6 25.3 22.6 45 47.9 45H346.9c25.3 0 46.3-19.7 47.9-45L416 128z"/>
                                                </svg>
                                            </a>
                                            <a href="{% url 'city-update' visit.id %}"
                                               class="inline-flex items-center gap-x-1.5 px-3 py-2 text-sm font-semibold rounded-lg border border-emerald-200 bg-emerald-50 text-emerald-700 hover:bg-emerald-100 dark:border-emerald-500/40 dark:bg-emerald-500/10 dark:text-emerald-400">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="size-4" viewBox="0 0 512 512" fill="currentColor">
                                                    <path d="M471.6 21.7c-21.9-21.9-57.3-21.9-79.2 0L362.3 51.7l97.9 97.9 30.1-30.1c21.9-21.9 21.9-57.3 0-79.2L471.6 21.7zm-299.2 220c-6.1 6.1-10.8 13.6-13.5 21.9l-29.6 88.8c-2.9 8.6-.6 18.1 5.8 24.6s15.9 8.7 24.6 5.8l88.8-29.6c8.2-2.7 15.7-7.4 21.9-13.5L437.7 172.3 339.7 74.3 172.4 241.7zM96 64C43 64 0 107 0 160V416c0 53 43 96 96 96H352c53 0 96-43 96-96V320c0-17.7-14.3-32-32-32s-32 14.3-32 32v96c0 17.7-14.3 32-32 32H96c-17.7 0-32-14.3-32-32V160c0-17.7 14.3-32 32-32h96c17.7 0 32-14.3 32-32s-14.3-32-32-32H96z"/>
                                                </svg>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% else %}
                    <div class="mt-8 pt-6 border-t border-gray-200 dark:border-neutral-700 text-center">
                        <p class="text-xl text-gray-600 dark:text-neutral-400">
                            Вы ещё не посетили город {{ city.title }}
                        </p>
                    </div>
                {% endif %}

                <div class="flex justify-end mt-6">
                    {% if number_of_visits > 0 %}
                        <a href="{% url 'city-create' %}?city_id={{ city.id }}"
                           class="inline-flex items-center gap-x-2 px-4 py-2 text-sm font-semibold rounded-lg border border-transparent bg-emerald-600 text-white hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2 dark:focus:ring-offset-neutral-800">
                            <svg xmlns="http://www.w3.org/2000/svg" class="size-4" viewBox="0 0 448 512" fill="currentColor">
                                <path d="M256 80c0-17.7-14.3-32-32-32s-32 14.3-32 32V224H48c-17.7 0-32 14.3-32 32s14.3 32 32 32H192V432c0 17.7 14.3 32 32 32s32-14.3 32-32V288H400c17.7 0 32-14.3 32-32s-14.3-32-32-32H256V80z"/>
                            </svg>
                            Добавить ещё одно посещение города
                        </a>
                    {% else %}
                        <a href="{% url 'city-create' %}?city_id={{ city.id }}"
                           class="inline-flex items-center gap-x-2 px-4 py-2 text-sm font-semibold rounded-lg border border-transparent bg-emerald-600 text-white hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2 dark:focus:ring-offset-neutral-800">
                            <svg xmlns="http://www.w3.org/2000/svg" class="size-4" viewBox="0 0 448 512" fill="currentColor">
                                <path d="M256 80c0-17.7-14.3-32-32-32s-32 14.3-32 32V224H48c-17.7 0-32 14.3-32 32s14.3 32 32 32H192V432c0 17.7 14.3 32 32 32s32-14.3 32-32V288H400c17.7 0 32-14.3 32-32s-14.3-32-32-32H256V80z"/>
                            </svg>
                            Добавить город как посещённый
                        </a>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>
</div>

{% if not DEBUG %}
    {% include 'advertisement/rtb_feed.html' %}

    {% if not user.is_authenticated %}
        {% include 'advertisement/rtb_floor_ad_mobile.html' %}
        {% include 'advertisement/rtb_floor_ad_desktop.html' %}
    {% endif %}
{% endif %}

{% include 'city/modal_city_statistic.html' %}

<!-- Модальное окно с картой (Preline UI) -->
<div id="mapModal" class="hs-overlay hidden size-full fixed top-0 start-0 z-[1060] overflow-x-hidden overflow-y-auto pointer-events-none flex items-center justify-center" role="dialog" tabindex="-1" aria-labelledby="mapModal_label">
    <div class="hs-overlay-animation-target hs-overlay-open:mt-7 hs-overlay-open:opacity-100 hs-overlay-open:duration-500 mt-0 opacity-0 ease-out transition-all sm:max-w-7xl sm:w-full m-3 h-[calc(100%-56px)] sm:mx-auto">
        <div class="max-h-full overflow-hidden flex flex-col bg-white border border-gray-200 shadow-2xs rounded-xl pointer-events-auto dark:bg-neutral-800 dark:border-neutral-700 dark:shadow-neutral-700/70">
            <!-- Header -->
            <div class="flex justify-between items-center py-3 px-4 border-b dark:border-neutral-700">
                <h3 class="font-bold text-gray-800 dark:text-white" id="mapModal_label">
                    Город {{city.title}} на карте
                </h3>
                <button type="button" class="flex justify-center items-center size-7 text-sm font-semibold rounded-full border border-transparent text-gray-800 hover:bg-gray-100 disabled:opacity-50 disabled:pointer-events-none dark:text-neutral-200 dark:hover:bg-neutral-700 dark:focus:outline-none dark:focus:ring-1 dark:focus:ring-gray-600" data-hs-overlay="#mapModal">
                    <span class="sr-only">Закрыть</span>
                    <svg class="flex-shrink-0 size-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="m18 6-12 12"></path>
                        <path d="m6 6 12 12"></path>
                    </svg>
                </button>
            </div>
            <!-- End Header -->

            <!-- Body -->
            <div class="flex-1 overflow-y-auto p-4">
                <div id="map" class="w-full h-[600px] rounded-lg"></div>
            </div>
            <!-- End Body -->
        </div>
    </div>
</div>

<!-- Модальное окно удаления (Preline UI) -->
<div id="deleteModal" class="hs-overlay hidden size-full fixed top-0 start-0 z-[1060] overflow-x-hidden overflow-y-auto pointer-events-none flex items-center justify-center" role="dialog" tabindex="-1" aria-labelledby="deleteModal_label">
    <div class="hs-overlay-animation-target hs-overlay-open:mt-7 hs-overlay-open:opacity-100 hs-overlay-open:duration-500 mt-0 opacity-0 ease-out transition-all sm:max-w-lg sm:w-full m-3 h-[calc(100%-56px)] sm:mx-auto">
        <div class="max-h-full overflow-hidden flex flex-col bg-white border border-gray-200 shadow-2xs rounded-xl pointer-events-auto dark:bg-neutral-800 dark:border-neutral-700 dark:shadow-neutral-700/70">
            <!-- Header -->
            <div class="flex justify-between items-center py-3 px-4 border-b dark:border-neutral-700">
                <h3 class="font-bold text-gray-800 dark:text-white" id="deleteModal_label">
                    Удаление
                </h3>
                <button type="button" class="flex justify-center items-center size-7 text-sm font-semibold rounded-full border border-transparent text-gray-800 hover:bg-gray-100 disabled:opacity-50 disabled:pointer-events-none dark:text-neutral-200 dark:hover:bg-neutral-700 dark:focus:outline-none dark:focus:ring-1 dark:focus:ring-gray-600" data-hs-overlay="#deleteModal">
                    <span class="sr-only">Закрыть</span>
                    <svg class="flex-shrink-0 size-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="m18 6-12 12"></path>
                        <path d="m6 6 12 12"></path>
                    </svg>
                </button>
            </div>
            <!-- End Header -->

            <!-- Body -->
            <div class="flex-1 overflow-y-auto p-4">
                <p class="text-sm text-gray-800 dark:text-white">
                    Вы уверены, что хотите удалить город <strong><span id="cityTitleOnModal"></span></strong> из списка посещённых?
                </p>
            </div>
            <!-- End Body -->

            <!-- Footer -->
            <div class="flex items-center justify-end gap-x-2 py-3 px-4 border-t border-gray-200 dark:border-neutral-700 shrink-0">
                <button type="button" class="py-2 px-4 inline-flex items-center gap-x-2 text-sm font-semibold rounded-lg border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-50 disabled:opacity-50 disabled:pointer-events-none focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 dark:bg-neutral-800 dark:border-neutral-700 dark:text-white dark:hover:bg-neutral-800 dark:focus:ring-offset-neutral-800" data-hs-overlay="#deleteModal">
                    Отмена
                </button>
                <form id="deleteCityForm" method="post" action="" class="inline">
                    {% csrf_token %}
                    <button type="submit" class="py-2 px-4 inline-flex items-center gap-x-2 text-sm font-semibold rounded-lg border border-transparent bg-red-600 text-white hover:bg-red-700 disabled:opacity-50 disabled:pointer-events-none focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 dark:focus:ring-offset-neutral-800">
                        Удалить
                    </button>
                </form>
            </div>
            <!-- End Footer -->
        </div>
    </div>
</div>

<script>
    window.CITY_TITLE = "{{ city.title }}";
    window.LAT = "{{ city.coordinate_width }}";
    window.LON = "{{ city.coordinate_longitude }}";
    window.ISO3166 = "{{ city.region.iso3166 }}"
    window.COUNTRY_CODE = "{{ city.country.code }}"
    window.TILE_LAYER = "{{ TILE_LAYER }}";
    window.URL_GEO_POLYGONS = "{{ URL_GEO_POLYGONS }}"
</script>
{% vite_asset 'js/entries/leaflet_css.js' %}
{% vite_asset 'js/entries/map_city_selected.js' %}
{% endblock %}
