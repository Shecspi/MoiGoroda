{% extends 'base.html' %}
{% load crispy_forms_filters %}
{% load mathfilters %}

{% block content %}
    <div class="container-fluid">
        <div class="row">
            <div class="col-xl-2 col-lg-3 col-md-4">
                <!-- Вкладки -->
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                            <a class="nav-link active" id="tab-list" data-toggle="pill" href="#content-list"
                               role="tab" aria-controls="content-list" aria-selected="true">
                                Список
                            </a>
                            <a class="nav-link" id="tab-map" data-toggle="pill" href="#content-map" role="tab"
                               aria-controls="content-map" aria-selected="false">
                                Карта
                            </a>
                        </div>
                    </div>
                </div>

                <div class="card mb-3">
                    <div class="card-body">
                        <a href="{% url 'cities-create' %}" class="btn btn-outline-primary btn-block">
                            Добавить город
                        </a>
                    </div>
                </div>
            </div>

            <div class="col-xl-10 col-lg-9 col-md-8">
                <div class="tab-content" id="v-pills-tabContent">
                    <div class="tab-pane fade show active" id="content-list" role="tabpanel" aria-labelledby="tab-list">
                        <!-- Таблица с перечнем посещённых городов -->
                        <div class="table-responsive-lg">
                            <table class="table table-hover table-sm">
                                <thead>
                                    <tr>
                                        <th>Регион</th>
                                        <th class="text-center">Федеральный округ</th>
                                        <th class="text-center">Посещено городов</th>
                                        <th class="text-center d-none d-xl-table-cell">Всего городов</th>
                                        <th class="text-center d-none d-lg-table-cell">Прогресс</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in object_list %}
                                        <tr>
                                            <!-- Регион -->
                                            <td>
                                                <span class="text-truncate">
                                                    <a href="{% url 'cities-by_region' item.id %}">
                                                        {{ item }}
                                                    </a>
                                                </span>
                                            </td>

                                            <!-- Федеральный округ -->
                                            <td class="text-center">
                                                <span class="text-truncate">
                                                    {{ item.area }}
                                                </span>
                                            </td>

                                            <!-- Посещено городов -->
                                            <td class="text-center">
                                                <span class="text-truncate">
                                                    {{ item.num_visited }}
                                                </span>
                                            </td>

                                            <!-- Всего городов -->
                                            <td class="text-center d-none d-xl-table-cell">
                                                <span class="text-truncate">
                                                    {{ item.num_total }}
                                                </span>
                                            </td>

                                            <!-- Прогресс -->
                                            <td class="text-center d-none d-lg-table-cell">
                                                <span class="text-truncate">
                                                    {% if item.num_visited > 0 %}
                                                        <div class="progress" data-toggle="tooltip" title="Tooltip on top">
                                                            <div class="progress-bar progress-bar-striped" role="progressbar"
                                                            style="width: {% widthratio item.num_visited item.num_total 100 %}%"
                                                            aria-valuenow="{% widthratio item.num_visited item.num_total 100 %}"
                                                            aria-valuemin="0" aria-valuemax="100"></div>
                                                        </div>
                                                    {% else %}
                                                        <i class="bi bi-x" style="color: red;"></i>
                                                    {% endif %}
                                                </span>
                                            </td>
                                        </tr>
                                    {%  empty %}
                                        <tr>
                                            <td colspan="6" class="text-center">
                                                Ещё не посещено ни одного города
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Пагинация -->
                        {% if page_obj.has_other_pages %}
                            <div class="row justify-content-center mb-3">
                                <div class="btn-group" role="group">
                                    {% if page_obj.has_previous %}
                                        <a href="?page=1" class="btn btn-outline-danger">
                                            <i class="bi bi-arrow-left-circle"></i> Первая
                                        </a>
                                        <a href="?page={{ page_obj.previous_page_number }}" class="btn btn-outline-danger">
                                            <i class="bi bi-arrow-left-short"></i> Предыдущая
                                        </a>
                                    {% endif %}

                                    <button class="btn btn-outline-dark" disabled>
                                        Страница {{ page_obj.number }} из {{ page_obj.paginator.num_pages }}
                                    </button>

                                    {% if page_obj.has_next %}
                                        <a href="?page={{ page_obj.next_page_number }}" class="btn btn-outline-success">
                                            Следуюшая <i class="bi bi-arrow-right-short"></i>
                                        </a>
                                        <a href="?page={{ page_obj.paginator.num_pages }}" class="btn btn-outline-success">
                                            Последняя <i class="bi bi-arrow-right-circle"></i>
                                        </a>
                                    {% endif %}
                                </div>
                            </div>
                        {% endif %}
                    </div>

                    <!-- Карта с отмеченными городами -->
                    <div class="tab-pane fade show" id="content-map" role="tabpanel" aria-labelledby="tab-map">
                        <div class="row">
                            <div class="col">
                                <div class="row">
                                    <div class="col">
                                        <div id="map" style="height: 600px"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        ymaps.ready(init);

        let regionList = new Map();
        {% for item in all_regions %}
            regionList.set('{{ item.iso3166 }}', '{{ item.num_visited }}');
        {% endfor %}
        console.log(regionList);

        function init() {
            let map = new ymaps.Map('map', {
                center: [58.01, 56.22],
                zoom: 4,
                type: 'yandex#map',
                controls: ['zoomControl']
            });
            map.controls.get('zoomControl').options.set({size: 'small'});

            let objectManager = new ymaps.ObjectManager();

            // Загрузим регионы и создаём объект regions, где ключи это ISO код региона
            ymaps.borders.load('RU', {
                lang: 'ru',
                quality: 2
            }).then(function (result) {
                let queue = [];
                let regions = result.features.reduce(function (acc, feature) {
                    let iso = feature.properties.iso3166;
                    feature.id = iso;
                    feature.options = {
                        fillOpacity: 0.6,
                        strokeColor: '#FFF',
                        strokeOpacity: 0.5,
                        visited: regionList.get(iso) > 0
                    };
                    acc[iso] = feature;
                    return acc;
                }, {});

                // Функция, которая раскрашивает регион и добавляет всех нераскрасшенных соседей в очередь на раскраску.
                function paint(iso) {
                    let region = regions[iso];

                    // Если у региона есть опция fillColor, значит мы его уже раскрасили.
                    if (region.options.fillColor) {
                        return;
                    }

                    if (region.options.visited) {
                        region.options.fillColor = '#32b700';
                    } else {
                        region.options.fillColor = '#9a9a9a';
                    }
                }

                for (let iso in regions) {
                    // Если регион не раскрашен, добавим его в очередь на раскраску.
                    if (!regions[iso].options.fillColor) {
                        queue.push(iso);
                    }
                    // Раскрасим все регионы из очереди.
                    while (queue.length > 0) {
                        paint(queue.shift());
                    }

                }

                // Добавим регионы на карту.
                result.features = [];
                for (let reg in regions) {
                    result.features.push(regions[reg]);
                }
                objectManager.add(result);
                map.geoObjects.add(objectManager);
            })
        }
    </script>
{% endblock %}
