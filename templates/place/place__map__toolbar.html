<div class="mx-3 my-3 flex flex-wrap items-center gap-3" id="toolbar">
    {% if not user.is_authenticated %}
    <p class="text-sm text-gray-600 dark:text-neutral-400 py-2">
        Зарегистрируйтесь, чтобы тоже отмечать свои места на карте.
    </p>
    <a href="{% url 'signup' %}" class="ml-auto inline-flex items-center gap-x-2 rounded-lg border border-blue-600 bg-white px-4 py-2 text-sm font-semibold text-blue-600 hover:bg-blue-50 dark:border-blue-500 dark:bg-transparent dark:text-blue-400 dark:hover:bg-blue-500/10">
        Регистрация
    </a>
    {% elif viewing_others_collection %}
    <!-- Просмотр чужой публичной коллекции: только счётчик и кнопка «Мои места» -->
    <div class="flex flex-wrap items-center gap-3 self-center" id="section-stats">
        <span class="stat-badge stat-badge-success">
            <span class="stat-badge-dot"></span>
            <span>Мест в коллекции: <strong>{{ collection_places_count }}</strong></span>
        </span>
    </div>
    <a href="{% url 'place_map' %}" class="ml-auto inline-flex items-center gap-x-2 py-3 px-4 text-sm font-medium rounded-lg border border-gray-200 bg-white text-teal-600 shadow-2xs hover:bg-gray-50 dark:bg-neutral-800 dark:border-neutral-700 dark:text-teal-500 dark:hover:bg-neutral-700">
        <svg class="size-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/>
        </svg>
        Мои места
    </a>
    {% else %}
    <style>
        /* Выбрана коллекция: красный (приватная) или зелёный (публичная) */
        #toolbar-collection-is-public:not(:disabled):not(:checked) + .place-collection-toggle-track {
            background-color: rgb(239 68 68);
        }
        .dark #toolbar-collection-is-public:not(:disabled):not(:checked) + .place-collection-toggle-track {
            background-color: rgb(220 38 38);
        }
        #toolbar-collection-is-public:not(:disabled):checked + .place-collection-toggle-track {
            background-color: rgb(22 163 74);
        }
        .dark #toolbar-collection-is-public:not(:disabled):checked + .place-collection-toggle-track {
            background-color: rgb(21 128 61);
        }
        /* Нет выбранной коллекции: серый приглушённый тон, только трек и ползунок (как disabled toggle) */
        .place-collection-toggle-wrap:has(#toolbar-collection-is-public:disabled) .place-collection-toggle-track {
            background-color: rgb(229 231 235);
        }
        .dark .place-collection-toggle-wrap:has(#toolbar-collection-is-public:disabled) .place-collection-toggle-track {
            background-color: rgb(82 82 91);
        }
        .place-collection-toggle-wrap:has(#toolbar-collection-is-public:disabled) .place-collection-toggle-label {
            color: rgb(107 114 128);
            opacity: 0.8;
        }
        .dark .place-collection-toggle-wrap:has(#toolbar-collection-is-public:disabled) .place-collection-toggle-label {
            color: rgb(161 161 170);
        }
        .place-collection-toggle-wrap:has(#toolbar-collection-is-public:disabled) .place-collection-toggle-icon {
            opacity: 0;
            pointer-events: none;
        }
    </style>
    <!-- Полный тулбар для владельца: статистика, фильтры, список коллекций -->
    <!-- Статистика -->
    <div class="flex flex-wrap items-center gap-3 self-center" id="section-stats">
        <div class="relative inline-block" id="block-statistic">
            <span class="stat-badge stat-badge-success" id="block-qty_places" title="Количество отмеченных мест на карте">
                <span class="stat-badge-dot"></span>
                <span id="block-qty_places-text">
                    <div class="inline-block size-4 animate-spin rounded-full border-2 border-solid border-current border-r-transparent" role="status">
                        <span class="sr-only">Загрузка...</span>
                    </div>
                    <span class="ml-2">Загружаю...</span>
                </span>
            </span>
        </div>
    </div>
    <!-- ^^^ Статистика -->

    <div class="ml-auto min-w-0 flex flex-wrap items-center gap-3 self-center">
        <!-- Публичность и «Поделиться» — показываются при выбранной коллекции, слева от кнопок -->
        <div id="toolbar-collection-actions" class="flex flex-wrap items-center gap-2 self-center">
            <!-- Переключатель приватности/публичности — переносится отдельно -->
            <div class="place-collection-toggle-wrap relative inline-block self-center" title="Переключить видимость коллекции: только вы или любой по ссылке">
                <div class="flex items-center gap-2">
                    <span class="place-collection-toggle-label text-sm text-gray-600 dark:text-neutral-400">Приватная</span>
                    <label for="toolbar-collection-is-public" class="relative inline-block w-[52px] h-7 cursor-pointer shrink-0">
                        <input type="checkbox"
                               id="toolbar-collection-is-public"
                               class="peer sr-only"
                               disabled>
                        <span class="place-collection-toggle-track absolute inset-0 bg-gray-200 rounded-full transition-colors duration-200 ease-in-out peer-checked:bg-blue-600 dark:bg-neutral-700 dark:peer-checked:bg-blue-500 peer-disabled:opacity-50 peer-disabled:pointer-events-none"></span>
                        <span class="absolute top-1/2 start-0.5 -translate-y-1/2 size-6 bg-white rounded-full shadow-xs transition-transform duration-200 ease-in-out peer-checked:translate-x-full dark:bg-neutral-400 dark:peer-checked:bg-white peer-disabled:bg-gray-300 dark:peer-disabled:bg-neutral-500"></span>
                        <!-- Left Icon (Приватная) -->
                        <span class="place-collection-toggle-icon absolute top-1/2 start-1 -translate-y-1/2 flex justify-center items-center size-5 text-red-500 peer-checked:text-white transition-colors duration-200 dark:text-red-400 dark:peer-checked:text-white">
                            <svg class="shrink-0 size-3" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M18 6 6 18"></path>
                                <path d="m6 6 12 12"></path>
                            </svg>
                        </span>
                        <!-- Right Icon (Публичная) -->
                        <span class="place-collection-toggle-icon absolute top-1/2 end-1 -translate-y-1/2 flex justify-center items-center size-5 text-white peer-checked:text-green-600 transition-colors duration-200 dark:text-white dark:peer-checked:text-green-500">
                            <svg class="shrink-0 size-3" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                        </span>
                    </label>
                    <span class="place-collection-toggle-label text-sm text-gray-600 dark:text-neutral-400">Публичная</span>
                </div>
            </div>
            <!-- Поделиться, Редактировать, Удалить — единый стиль кнопок, различаются только иконкой и цветом -->
            <div class="flex items-center gap-2 self-center shrink-0">
                <button type="button" id="toolbar-collection-share" disabled
                    class="inline-flex items-center justify-center size-10 rounded-xl border transition focus:outline-none focus:ring-2 focus:ring-offset-2 disabled:opacity-50 disabled:pointer-events-none disabled:border-gray-200 disabled:text-gray-400 disabled:hover:bg-transparent dark:disabled:border-neutral-700 dark:disabled:text-neutral-500 dark:disabled:hover:bg-transparent border-blue-500 text-blue-600 hover:bg-blue-50 focus:ring-blue-500 dark:border-blue-400 dark:text-blue-300 dark:hover:bg-blue-500/10 dark:focus:ring-blue-500"
                    title="Поделиться ссылкой на коллекцию">
                    <svg class="size-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/>
                    </svg>
                </button>
                <button type="button" id="toolbar-collection-edit" disabled
                    class="inline-flex items-center justify-center size-10 rounded-xl border transition focus:outline-none focus:ring-2 focus:ring-offset-2 disabled:opacity-50 disabled:pointer-events-none disabled:border-gray-200 disabled:text-gray-400 disabled:hover:bg-transparent dark:disabled:border-neutral-700 dark:disabled:text-neutral-500 dark:disabled:hover:bg-transparent border-gray-300 text-gray-700 hover:bg-gray-50 focus:ring-gray-400 dark:border-neutral-600 dark:text-neutral-300 dark:hover:bg-neutral-700 dark:focus:ring-neutral-500"
                    title="Редактировать название коллекции"
                    data-hs-overlay="#modal-edit-place-collection">
                    <svg class="size-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                    </svg>
                </button>
                <button type="button" id="toolbar-collection-delete" disabled
                    class="inline-flex items-center justify-center size-10 rounded-xl border transition focus:outline-none focus:ring-2 focus:ring-offset-2 disabled:opacity-50 disabled:pointer-events-none disabled:border-gray-200 disabled:text-gray-400 disabled:hover:bg-transparent dark:disabled:border-neutral-700 dark:disabled:text-neutral-500 dark:disabled:hover:bg-transparent border-red-300 text-red-600 hover:bg-red-50 focus:ring-red-400 dark:border-red-600 dark:text-red-400 dark:hover:bg-red-500/10 dark:focus:ring-red-500"
                    title="Удалить коллекцию"
                    data-hs-overlay="#modal-delete-place-collection">
                    <svg class="size-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                </button>
            </div>
        </div>
        <!-- ^^^ Публичность; Поделиться + Редактировать + Удалить -->

        <div class="relative inline-block self-center shrink-0">
            <a href="{% url 'place_collections_list' %}"
               class="py-3 px-4 inline-flex items-center gap-x-2 text-sm font-medium rounded-lg border border-gray-200 bg-white text-teal-600 shadow-2xs hover:bg-gray-50 focus:outline-hidden focus:bg-gray-50 disabled:opacity-50 disabled:pointer-events-none dark:bg-neutral-800 dark:border-neutral-700 dark:text-teal-500 dark:hover:bg-neutral-700 dark:focus:bg-neutral-700"
               title="Открыть список ваших коллекций мест">
                <svg class="size-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/>
                </svg>
                <span>Список коллекций</span>
            </a>
        </div>

        <!-- Фильтр по категории (как на /city/districts/98/map) -->
        <div class="hs-dropdown relative z-[40] min-w-0 w-full sm:w-auto sm:min-w-[220px]" id="dropdown-category-wrap">
            <button class="hs-dropdown-toggle hs-select-disabled:pointer-events-none hs-select-disabled:opacity-50 relative z-0 py-3 ps-4 pe-9 flex items-center gap-x-2 min-w-0 w-full sm:w-[220px] cursor-pointer bg-white border border-gray-200 rounded-lg text-start text-sm text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:pointer-events-none disabled:opacity-50 dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-200 dark:focus:ring-neutral-600 overflow-hidden box-border"
                    id="btn-filter-category"
                    disabled>
                <span class="inline-block size-4 animate-spin rounded-full border-2 border-solid border-current border-r-transparent" role="status">
                    <span class="sr-only">Загрузка...</span>
                </span>
                <span id="btn-filter-category-icon" class="hidden shrink-0 inline-flex items-center" aria-hidden="true">
                    <svg xmlns="http://www.w3.org/2000/svg" class="size-4" viewBox="0 0 512 512" fill="currentColor">
                        <path d="M12.41 148.02l232.94 105.67c6.8 3.09 14.49 3.09 21.29 0l232.94-105.67c16.55-7.51 16.55-32.52 0-40.03L266.65 2.31a25.607 25.607 0 0 0-21.29 0L12.41 107.98c-16.55 7.51-16.55 32.52 0 40.03zm487.18 88.28l-58.09-26.33-161.64 73.27c-7.56 3.43-15.59 5.17-23.86 5.17s-16.29-1.74-23.86-5.17L70.88 209.97l-58.1 26.33c-16.55 7.5-16.55 32.52 0 40.02l232.94 105.59c6.8 3.08 14.49 3.08 21.29 0L499.59 276.3c16.55-7.5 16.55-32.52 0-40.02zm0 127.8l-57.87-26.23-161.86 73.37c-7.56 3.43-15.59 5.17-23.86 5.17s-16.29-1.74-23.86-5.17L70.88 337.97 12.23 364.1c-16.55 7.5-16.55 32.52 0 40.02l232.94 105.59c6.8 3.08 14.49 3.08 21.29 0L499.59 404.1c16.55-7.5 16.55-32.52 0-40.02z"/>
                    </svg>
                </span>
                <span id="btn-filter-category-text" class="hidden">Категории</span>
                <div class="absolute top-1/2 end-3 -translate-y-1/2 pointer-events-none">
                    <svg class="shrink-0 size-3.5 text-gray-500 dark:text-neutral-500" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m7 15 5 5 5-5"/><path d="m7 9 5-5 5 5"/></svg>
                </div>
            </button>
            <span id="badge-filter-category" class="absolute top-0 end-0 inline-flex items-center size-3.5 rounded-full border-2 border-white transform -translate-y-1/2 translate-x-1/2 bg-orange-500 dark:border-neutral-900 hidden pointer-events-none" aria-hidden="true"></span>
            <ul class="hs-dropdown-menu absolute start-0 opacity-0 pointer-events-none transition-[opacity,margin] duration-150 mt-2 max-h-72 overflow-y-auto overscroll-contain w-full sm:w-auto sm:min-w-[280px] bg-white border border-gray-200 rounded-lg shadow-lg py-1 px-1 space-y-0.5 z-[1000] dark:bg-neutral-900 dark:border-neutral-700 dark:shadow-neutral-900/50 [&::-webkit-scrollbar]:w-2 [&::-webkit-scrollbar-thumb]:rounded-full [&::-webkit-scrollbar-track]:bg-gray-100 [&::-webkit-scrollbar-thumb]:bg-gray-300 dark:[&::-webkit-scrollbar-track]:bg-neutral-700 dark:[&::-webkit-scrollbar-thumb]:bg-neutral-500" id="dropdown-menu-filter-category"></ul>
        </div>
        <!-- ^^^ Фильтр по категории -->

        <!-- Фильтр по коллекции (как на /city/districts/98/map) -->
        <div class="hs-dropdown relative z-[40] min-w-0 w-full sm:w-auto sm:min-w-[220px]" id="dropdown-collection-wrap">
            <button class="hs-dropdown-toggle hs-select-disabled:pointer-events-none hs-select-disabled:opacity-50 relative z-0 py-3 ps-4 pe-9 flex items-center gap-x-2 min-w-0 w-full sm:w-[220px] cursor-pointer bg-white border border-gray-200 rounded-lg text-start text-sm text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:pointer-events-none disabled:opacity-50 dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-200 dark:focus:ring-neutral-600 overflow-hidden box-border"
                    id="btn-filter-collection"
                    disabled>
                <span class="inline-block size-4 shrink-0 animate-spin rounded-full border-2 border-solid border-current border-r-transparent" role="status">
                    <span class="sr-only">Загрузка...</span>
                </span>
                <span id="btn-filter-collection-icon" class="hidden shrink-0 inline-flex items-center" aria-hidden="true">
                    <svg class="size-4" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                    </svg>
                </span>
                <span id="btn-filter-collection-text" class="hidden min-w-0 truncate block" title="Коллекции">Коллекции</span>
                <div class="absolute top-1/2 end-3 -translate-y-1/2 pointer-events-none">
                    <svg class="shrink-0 size-3.5 text-gray-500 dark:text-neutral-500" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m7 15 5 5 5-5"/><path d="m7 9 5-5 5 5"/></svg>
                </div>
            </button>
            <span id="badge-filter-collection" class="absolute top-0 end-0 inline-flex items-center size-3.5 rounded-full border-2 border-white transform -translate-y-1/2 translate-x-1/2 bg-orange-500 dark:border-neutral-900 hidden pointer-events-none" aria-hidden="true"></span>
            <ul class="hs-dropdown-menu absolute start-0 opacity-0 pointer-events-none transition-[opacity,margin] duration-150 mt-2 max-h-72 overflow-y-auto overscroll-contain w-full sm:w-auto sm:min-w-[280px] bg-white border border-gray-200 rounded-lg shadow-lg py-1 px-1 space-y-0.5 z-[1000] dark:bg-neutral-900 dark:border-neutral-700 dark:shadow-neutral-900/50 [&::-webkit-scrollbar]:w-2 [&::-webkit-scrollbar-thumb]:rounded-full [&::-webkit-scrollbar-track]:bg-gray-100 [&::-webkit-scrollbar-thumb]:bg-gray-300 dark:[&::-webkit-scrollbar-track]:bg-neutral-700 dark:[&::-webkit-scrollbar-thumb]:bg-neutral-500" id="dropdown-menu-filter-collection"></ul>
        </div>
        <!-- ^^^ Фильтр по коллекции -->
    </div>
    {% endif %}
</div>
